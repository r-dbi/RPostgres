# RPostgres Development Instructions

RPostgres is a DBI-compliant interface to PostgreSQL databases written
in C++ using cpp11. It provides a modern, fast, and secure interface for
connecting R to PostgreSQL.

Always reference these instructions first and fallback to search or bash
commands only when you encounter unexpected information that does not
match the info here.

## Working Effectively

### Prerequisites and Setup

Install required system dependencies:

``` bash
sudo apt update
sudo apt install -y libpq-dev build-essential pkg-config postgresql postgresql-client
```

Install R using rig (R Installation and Management):

``` bash
# Install rig
curl -Ls https://github.com/r-lib/rig/releases/download/latest/rig-linux-latest.tar.gz | sudo tar xz -C /usr/local
# Install latest R version
sudo rig add release
# Ensure R and tools are in PATH
sudo rig system make-links
```

Set up PostgreSQL for testing:

``` bash
# Start PostgreSQL service
sudo service postgresql start

# Create test user and database
sudo -u postgres createuser -s runner
sudo -u postgres psql -c "ALTER USER runner PASSWORD 'test123';"
sudo -u postgres createdb testdb
```

Install essential R packages using pak:

``` bash
R -q -e 'pak::pak(); pak::pak(c("devtools", "r-lib/roxygen2", "r-lib/pkgdown"))'
```

Install air for code formatting:

``` bash
curl -LsSf https://github.com/posit-dev/air/releases/latest/download/air-installer.sh | sh
```

### Code Formatting

Format code using air:

``` bash
air format .
# Formats all supported files in the current directory and subdirectories
```

### Environment Variables for Testing

Always set these PostgreSQL environment variables before running tests:

``` bash
export PGHOST=localhost
export PGPORT=5432
export PGUSER=runner
export PGPASSWORD=test123
export PGDATABASE=testdb
```

### Core Development Commands

Install the package for development:

``` bash
UserNM=true R CMD INSTALL .
# Takes ~30 seconds. NEVER CANCEL. Set timeout to 60+ seconds.
```

Run lightweight tests (for quick iteration):

``` bash
# Must set PostgreSQL environment variables first!
export PGHOST=localhost PGPORT=5432 PGUSER=runner PGPASSWORD=test123 PGDATABASE=testdb
R -q -e 'testthat::test_local()'
# Takes ~30 seconds. NEVER CANCEL. Set timeout to 60+ seconds.
```

Build and check the package using rcmdcheck:

``` bash
# Must set PostgreSQL environment variables first!
export PGHOST=localhost PGPORT=5432 PGUSER=runner PGPASSWORD=test123 PGDATABASE=testdb _R_CHECK_PKG_SIZES_=FALSE
R -q -e 'rcmdcheck::rcmdcheck(args = "--no-manual", error_on = "note")'
# Takes ~100 seconds. NEVER CANCEL. Set timeout to 180+ seconds.
```

Test pkgdown documentation build:

``` bash
R -q -e 'pkgdown::build_site(preview = FALSE)'
# Takes ~60 seconds. NEVER CANCEL. Set timeout to 120+ seconds.
```

Update documentation (requires devtools):

``` bash
R -q -e 'devtools::document()'
# Takes ~20 seconds. NEVER CANCEL. Set timeout to 60+ seconds.
```

## Validation

### Manual Testing Scenarios

Always test database connectivity after making changes:

``` r
library(RPostgres)
con <- dbConnect(Postgres(), host='localhost', dbname='testdb', user='runner', password='test123')
dbListTables(con)
dbWriteTable(con, 'test_table', data.frame(x=1:3, y=letters[1:3]))
result <- dbGetQuery(con, 'SELECT * FROM test_table')
print(result)
dbDisconnect(con)
```

### Required Testing Before Committing

1.  ALWAYS run `air format .` to format code before committing
2.  ALWAYS build and install the package successfully
3.  ALWAYS run
    [`testthat::test_local()`](https://testthat.r-lib.org/reference/test_package.html)
    for quick iteration testing
4.  ALWAYS run `rcmdcheck::rcmdcheck()` with PostgreSQL environment
    variables set for comprehensive testing
5.  ALWAYS test
    [`pkgdown::build_site()`](https://pkgdown.r-lib.org/reference/build_site.html)
    to ensure documentation builds correctly
6.  ALWAYS test basic database connectivity and operations
7.  Run `devtools::document()` if you modified any roxygen comments in R
    files

## Build System Details

### C++ Compilation Requirements

- Requires `libpq-dev` for PostgreSQL client library headers
- Requires `pkg-config` to find PostgreSQL libraries
- Uses `cpp11` for R-C++ interface
- Compilation takes ~20-25 seconds for full rebuild

### Key Configuration Files

- `src/Makevars.in`: Template for C++ compilation flags (configured by
  `configure` script)
- `configure`: Shell script that detects PostgreSQL installation and
  sets compilation flags
- `DESCRIPTION`: R package metadata including dependencies
- `NAMESPACE`: Exported functions (auto-generated by roxygen2)

### Testing Infrastructure

- Uses `testthat` framework in `tests/testthat/`
- Uses `DBItest` for comprehensive DBI compliance testing
- Tests require running PostgreSQL database with
  [`postgresDefault()`](https://rpostgres.r-dbi.org/reference/postgresHasDefault.md)
  function
- Test helper in `tests/testthat/helper-DBItest.R` configures DBItest
- Environment variables (PGHOST, PGUSER, etc.) must be set for tests to
  pass

## Common Development Tasks

### Repository Structure

``` text
RPostgres/
├── R/                    # R source code
├── src/                  # C++ source code
├── tests/testthat/       # Unit tests
├── man/                  # Documentation (auto-generated)
├── vignettes/           # Package vignettes
├── inst/                # Installed files
├── .github/workflows/   # CI/CD configuration
├── configure            # Build configuration script
└── DESCRIPTION          # Package metadata
```

### Key Source Files

- `R/PqConnection.R`: Main connection class
- `R/PqResult.R`: Result set handling
- `R/default.R`: Default connection helpers
  ([`postgresDefault()`](https://rpostgres.r-dbi.org/reference/postgresHasDefault.md))
- `src/connection.cpp`: C++ connection implementation
- `src/result.cpp`: C++ result set implementation

### Documentation

- Uses roxygen2 with Markdown syntax
- Run `devtools::document()` after modifying roxygen comments
- Manual pages auto-generated in `man/` directory
- Never edit `.Rd` files directly - edit roxygen comments in `.R` files

### GitHub Actions Workflow

The CI runs on multiple R versions and OS combinations:

- Installs system dependencies via
  `.github/workflows/install/action.yml`
- Sets up PostgreSQL via
  `.github/workflows/custom/after-install/action.yml`
- Runs R CMD check with comprehensive testing via
  `.github/workflows/check/action.yml`
- Build logs show compilation times and test results

### Docker Development Environment

Optional development using docker-compose:

``` bash
# Uses official postgres + custom R development image
docker-compose up -d postgres
# Access workspace container for development
```

## Error Handling and Troubleshooting

### Common Build Issues

- **“libpq-fe.h not found”**: Install `libpq-dev` package
- **“pkg-config not found”**: Install `pkg-config` package
- **PostgreSQL connection fails**: Check PostgreSQL service is running
  and environment variables are set
- **Roxygen version mismatch**: Update roxygen2 or ignore warning for
  documentation generation

### Test Failures

- Tests require PostgreSQL running and environment variables set
- [`postgresDefault()`](https://rpostgres.r-dbi.org/reference/postgresHasDefault.md)
  function needs PGHOST, PGUSER, PGPASSWORD, PGDATABASE
- DBItest failures usually indicate PostgreSQL connection issues
- Check PostgreSQL logs if connections fail:
  `sudo journalctl -u postgresql`

### Performance Notes

- C++ compilation is CPU-intensive, takes 20-25 seconds
- Full rcmdcheck takes ~100 seconds due to comprehensive test suite
- Documentation generation rebuilds package, takes ~20 seconds
- pkgdown site building takes ~60 seconds
- Network access may be limited in CI environments

## Critical Reminders

- **NEVER CANCEL builds or long-running commands** - C++ compilation may
  take 25+ seconds, tests may take 100+ seconds
- **ALWAYS set PostgreSQL environment variables** before running tests
  or rcmdcheck
- **ALWAYS test database connectivity** after making changes to C++ code
- Set timeouts of 180+ seconds for rcmdcheck, 120+ seconds for pkgdown
  builds, 60+ seconds for builds and documentation
- Use `sudo` for package installation when needed for system library
  access
